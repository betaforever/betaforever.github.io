<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Http表单文件上传 | LAxrh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0. 介绍在开发的过程中不免会使用的文件上传的功能。实习的时候第一次见到工程代码里面有使用Http的方式来上传用户图片的代码，感觉好复杂，各种字段不明其意。下面就使用表单加上Servlet的方式看看文件如何上传。
1. 创建一个文件上传表单这东西也是大二的时候学的，现在已经忘记的差不多了。代码如下：
1&amp;#60;html&amp;#62;&amp;#10;&amp;#9;&amp;#60;head&amp;#62;&amp;#10;&amp;#9;&amp;#">
<meta property="og:type" content="article">
<meta property="og:title" content="Http表单文件上传">
<meta property="og:url" content="http://yoursite.com/2015/08/21/http_upload_file/index.html">
<meta property="og:site_name" content="LAxrh">
<meta property="og:description" content="0. 介绍在开发的过程中不免会使用的文件上传的功能。实习的时候第一次见到工程代码里面有使用Http的方式来上传用户图片的代码，感觉好复杂，各种字段不明其意。下面就使用表单加上Servlet的方式看看文件如何上传。
1. 创建一个文件上传表单这东西也是大二的时候学的，现在已经忘记的差不多了。代码如下：
1&amp;#60;html&amp;#62;&amp;#10;&amp;#9;&amp;#60;head&amp;#62;&amp;#10;&amp;#9;&amp;#">
<meta property="og:image" content="http://yoursite.com/images/http_upload_file/upload_form.png">
<meta property="og:image" content="http://yoursite.com/images/http_upload_file/upload_1_byte_request_body.png">
<meta property="og:updated_time" content="2015-08-21T13:19:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Http表单文件上传">
<meta name="twitter:description" content="0. 介绍在开发的过程中不免会使用的文件上传的功能。实习的时候第一次见到工程代码里面有使用Http的方式来上传用户图片的代码，感觉好复杂，各种字段不明其意。下面就使用表单加上Servlet的方式看看文件如何上传。
1. 创建一个文件上传表单这东西也是大二的时候学的，现在已经忘记的差不多了。代码如下：
1&amp;#60;html&amp;#62;&amp;#10;&amp;#9;&amp;#60;head&amp;#62;&amp;#10;&amp;#9;&amp;#">
  
    <link rel="alternative" href="/atom.xml" title="LAxrh" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="null" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">YangHui</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Keep looking, Don&#39;t settle</p>
		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">YangHui</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="null" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">YangHui</h1>
			</hgroup>
			
			<p class="header-subtitle">Keep looking, Don&#39;t settle</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-http_upload_file" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/21/http_upload_file/" class="article-date">
  	<time datetime="2015-08-20T16:00:00.000Z" itemprop="datePublished">2015-08-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Http表单文件上传
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/文件上传/">文件上传</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
			
			<div id="toc" class="toc-article">
			  <strong class="toc-title">目录</strong>
			  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-_介绍"><span class="toc-text">0. 介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-_创建一个文件上传表单"><span class="toc-text">1. 创建一个文件上传表单</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-_后端Servlet处理"><span class="toc-text">2. 后端Servlet处理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-部署、运行"><span class="toc-text">3.部署、运行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1_Tomcat下创建项目"><span class="toc-text">3.1 Tomcat下创建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2_编译Servlet代码"><span class="toc-text">3.2 编译Servlet代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3_配置Servlet"><span class="toc-text">3.3 配置Servlet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4_运行"><span class="toc-text">3.4 运行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Request_Body"><span class="toc-text">4.Request Body</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-_提取文件"><span class="toc-text">5. 提取文件</span></a></li></ol>
			</div>
			

        <h1 id="0-_介绍">0. 介绍</h1><p>在开发的过程中不免会使用的文件上传的功能。实习的时候第一次见到工程代码里面有使用Http的方式来上传用户图片的代码，感觉好复杂，各种字段不明其意。下面就使用表单加上Servlet的方式看看文件如何上传。</p>
<h1 id="1-_创建一个文件上传表单">1. 创建一个文件上传表单</h1><p>这东西也是大二的时候学的，现在已经忘记的差不多了。代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;html&#62;&#10;&#9;&#60;head&#62;&#10;&#9;&#9;&#60;title&#62;File Uploading Form&#60;/title&#62;&#10;&#9;&#60;/head&#62;&#10;&#9;&#60;body&#62;&#10;&#9;&#9;&#60;h3&#62;File Upload:&#60;/h3&#62; Select a file to upload: &#60;br /&#62;&#10;&#9;&#9;&#60;form action=&#34;UploadServlet&#34; method=&#34;post&#34; enctype=&#34;multipart/form-data&#34;&#62;&#10;&#9;&#9;&#60;input type=&#34;file&#34; name=&#34;file&#34; size=&#34;50&#34; /&#62;&#10;&#9;&#9;&#60;br /&#62;&#10;&#9;&#9;&#60;input type=&#34;submit&#34; value=&#34;Upload File&#34; /&#62;&#10;&#9;&#9;&#60;/form&#62;&#10;&#9;&#60;/body&#62;&#10;&#60;/html&#62;</span><br></pre></td></tr></table></figure>
<p>上面部分有下面几点必须注意：</p>
<ul>
<li><strong>method</strong> 必须为 <strong>post</strong></li>
<li><strong>enctype</strong> 设置为 <strong>multipart/form-data</strong></li>
<li><strong>action</strong> 要和你的Servlet文件名称一致</li>
</ul>
<a id="more"></a>
<h1 id="2-_后端Servlet处理">2. 后端Servlet处理</h1><p>Servlet要做的事情就是相应文件上传的事件。由于使用的是<strong>Post</strong>方式，所以，在Servlet代码中需要重写<strong>doPost</strong>方法。代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import java.io.File;&#10;import java.util.List;&#10;import java.io.FileOutputStream;&#10;import java.io.IOException;&#10;import java.io.InputStream;&#10;import java.util.Enumeration;&#10;&#10;import javax.servlet.ServletException;&#10;import javax.servlet.http.HttpServlet;&#10;import javax.servlet.http.HttpServletRequest;&#10;import javax.servlet.http.HttpServletResponse;&#10;&#10;public class UploadServlet extends HttpServlet &#123;&#10;&#9;static final String SAVE_DIR = &#34;E:/Test/Upload/&#34;;&#10;&#9;static final int BUFFER_SIZE = 4096;&#10;&#9;protected void doPost(HttpServletRequest request,&#10;&#9;&#9;HttpServletResponse response) throws ServletException, IOException&#123;&#10;&#10;&#9;&#9;String fileName = &#34;request.bin&#34;;&#10;&#9;&#9;File saveFile = new File(SAVE_DIR + fileName);&#10;&#10;&#9;&#9;System.out.println(&#34;===== Begin headers =====&#34;);&#10;&#9;&#9;Enumeration&#60;String&#62; names = request.getHeaderNames();&#10;&#9;&#9;while (names.hasMoreElements()) &#123;&#10;&#9;&#9;&#9;String headerName = names.nextElement();&#10;&#9;&#9;&#9;System.out.println(headerName + &#34; = &#34; + request.getHeader(headerName));&#9;&#9;&#9;&#10;&#9;&#9;&#125;&#10;&#9;&#9;System.out.println(&#34;===== End headers =====\n&#34;);&#10;&#9;&#9;// raw data&#10;&#9;&#9;InputStream inputStream = request.getInputStream();&#10;&#9;&#9;FileOutputStream outputStream = new FileOutputStream(saveFile);&#10;&#9;&#9;&#10;&#9;&#9;byte[] buffer = new byte[BUFFER_SIZE];&#10;&#9;&#9;int bytesRead = -1;&#10;&#9;&#9;System.out.println(&#34;Receiving data...&#34;);&#10;&#9;&#9;&#10;&#9;&#9;while ((bytesRead = inputStream.read(buffer)) != -1) &#123;&#10;&#9;&#9;&#9;outputStream.write(buffer, 0, bytesRead);&#10;&#9;&#9;&#125;&#10;&#9;&#9;&#10;&#9;&#9;System.out.println(&#34;Data received.&#34;);&#10;&#9;&#9;outputStream.close();&#10;&#9;&#9;inputStream.close();&#10;&#9;&#9;&#10;&#9;&#9;System.out.println(&#34;File written to: &#34; + saveFile.getAbsolutePath());&#10;&#9;&#9;response.getWriter().print(&#34;UPLOAD DONE&#34;);&#10;&#9;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>获得请求之后，首先打印了请求的头部信息，然后再将<strong>Request Body</strong>（注意不是文件数据）的数据存储到文件中。</p>
<h1 id="3-部署、运行">3.部署、运行</h1><p>平台：Windows8.1</p>
<p>Http服务器：Tomcat8.0.24</p>
<h2 id="3-1_Tomcat下创建项目">3.1 Tomcat下创建项目</h2><p>这个测试项目很简单，没有必要使用其他的工具，可以直接复制Tomcat下面的实例工程修改即可。</p>
<p>第一步：在<strong>webapps</strong>目录下建立一个名称为<strong>upload</strong>的文件夹。</p>
<p>第二步：在<strong>upload</strong>目录下创建<strong>WEB-INF</strong>目录，再在<strong>WEB-INF</strong>目录下创建存放class文件的目录<strong>classes</strong>。</p>
<p>第三步：将最开始的表单代码保存为<strong>index.html</strong>，存放到<strong>upload</strong>目录下。</p>
<p>第四步：将<strong>ROOT/WEB-INF</strong>目录下面的<strong>web.xml</strong>配置文件拷贝到<strong>upload/WEB-INF</strong>。</p>
<h2 id="3-2_编译Servlet代码">3.2 编译Servlet代码</h2><p>Servlet代码文件只有一个，所以，直接用命令行编译即可。不过需要注意的包名（这里没有）相关问题。由于使用了Servlet，所以在编译的时候需要指定jar包。</p>
<p>将上面的Servlet代码保存为<strong>UploadServlet.java</strong>文件，放在你操作方便的地方。打开命令行窗口，输入如下命令编译：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -cp .;[Tomcat&#26681;&#30446;&#24405;]/lib/servlet-api.jar UploadServlet.java</span><br></pre></td></tr></table></figure></p>
<p>编译完成之后，会在当前目录下面生成一个class文件。</p>
<h2 id="3-3_配置Servlet">3.3 配置Servlet</h2><p>将上一步生成的class文件拷贝到<strong>WEB-INF/classes</strong>目录下面。再打开web.xml配置文件。添加如下配置代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;servlet&#62;&#10;&#9;  &#60;servlet-name&#62;UploadServlet&#60;/servlet-name&#62;&#10;&#9;  &#60;servlet-class&#62;UploadServlet&#60;/servlet-class&#62;&#10;  &#60;/servlet&#62;&#10;&#10;  &#60;servlet-mapping&#62;&#10;&#9;  &#60;servlet-name&#62;UploadServlet&#60;/servlet-name&#62;&#10;&#9;  &#60;url-pattern&#62;/UploadServlet&#60;/url-pattern&#62;&#10;  &#60;/servlet-mapping&#62;</span><br></pre></td></tr></table></figure>
<h2 id="3-4_运行">3.4 运行</h2><p>打开Tomcat目录下的bin目录，双击运行<strong>startup.bat</strong>脚本，查看控制台是否有错误信息。运行了服务器之后，就可以用浏览器来访问了。在浏览器中输入如下地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/upload/</span><br></pre></td></tr></table></figure>
<p>如果你修改了端口，请改成你自己的端口号。这时就有一个简单的提交文件的界面出现，如下图所示：<br><img src="/images/http_upload_file/upload_form.png" alt="表单"><br>这时就可以通过这个界面上传文件了。</p>
<h1 id="4-Request_Body">4.Request Body</h1><p>如果你上传了文件，你会发现文件数据有问题，并不是那个文件的数据。对，上面的servlet保存的是Request Body的所有数据。因此，它不仅仅包含了文件数据，还包含了分割符，<strong>Content-type</strong>，<strong>content-disposition</strong>等等信息。这个具体信息请参见<a href="http://www.ietf.org/rfc/rfc1867.txt" target="_blank" rel="external">RFC1867</a> 的第6节的实例。</p>
<p>先来看看，上传一个1byte的文本文件上传之后的数据。使用二进制工具打开，如下图所示：<br><!----><br><img src="/images/http_upload_file/upload_1_byte_request_body.png" alt="上传文件"><br>这里主要关注回车和换行。可以看到和RFC中的实例都是可以对应上的。</p>
<h1 id="5-_提取文件">5. 提取文件</h1><p>在Servlet基本的方法中并没有一个很好的方法来获取文件的数据，不过Apache提供了另外一个开源库来做这件事情。库的名称是：<strong>commons-fileupload</strong>。到目前为止版本号为<strong>1.3.1</strong>。需要注意的是这个库依赖<strong>commons-io</strong>这个库。两个库都可以到官方网站上下载。最后，修改代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import java.io.File;&#10;import java.util.List;&#10;import java.io.FileOutputStream;&#10;import java.io.IOException;&#10;import java.io.InputStream;&#10;import java.util.Enumeration;&#10;&#10;import javax.servlet.ServletException;&#10;import javax.servlet.http.HttpServlet;&#10;import javax.servlet.http.HttpServletRequest;&#10;import javax.servlet.http.HttpServletResponse;&#10;&#10;import org.apache.commons.fileupload.FileItem;&#10;import org.apache.commons.fileupload.disk.DiskFileItemFactory;&#10;import org.apache.commons.fileupload.servlet.ServletFileUpload;&#10;import org.apache.commons.fileupload.FileUploadException;&#10;&#10;public class UploadServlet extends HttpServlet &#123;&#10;&#9;static final String SAVE_DIR = &#34;E:/Test/Upload/&#34;;&#10;&#9;static final int BUFFER_SIZE = 4096;&#10;&#9;&#10;&#9;protected void doPost(HttpServletRequest request,&#10;&#9;&#9;HttpServletResponse response) throws ServletException, IOException&#123;&#10;&#10;&#9;&#9;String fileName = &#34;request.bin&#34;;&#10;&#9;&#9;File saveFile = new File(SAVE_DIR + fileName);&#10;&#10;&#9;&#9;System.out.println(&#34;===== Begin headers =====&#34;);&#10;&#9;&#9;Enumeration&#60;String&#62; names = request.getHeaderNames();&#10;&#9;&#9;while (names.hasMoreElements()) &#123;&#10;&#9;&#9;&#9;String headerName = names.nextElement();&#10;&#9;&#9;&#9;System.out.println(headerName + &#34; = &#34; + request.getHeader(headerName));&#9;&#9;&#9;&#10;&#9;&#9;&#125;&#10;&#9;&#9;System.out.println(&#34;===== End headers =====\n&#34;);&#10;&#10;&#9;&#9;try&#10;&#9;&#9;&#123;&#10;&#9;&#9;&#9;request.setCharacterEncoding(&#34;UTF-8&#34;);&#10;&#9;&#9;&#9;DiskFileItemFactory factory = new DiskFileItemFactory();&#10;&#9;&#9;&#9;ServletFileUpload sfu = new ServletFileUpload(factory);&#10;&#9;&#9;&#9;List&#60;FileItem&#62; fileItems = sfu.parseRequest(request);&#10;&#9;&#9;&#9;for(int i = 0;i &#60; fileItems.size(); i++)&#123;&#10;&#9;&#9;&#9;&#9;FileItem item = fileItems.get(i);&#10;&#9;&#9;&#9;&#9;if(item.isFormField())&#123;&#10;&#9;&#9;&#9;&#9;&#125;else&#123;&#10;&#9;&#9;&#9;&#9;&#9;fileName = item.getName();&#10;&#9;&#9;&#9;&#9;&#9;String dir = SAVE_DIR;&#10;&#9;&#9;&#9;&#9;&#9;item.write(new File(dir + fileName));&#10;&#10;&#9;&#9;&#9;&#9;&#125;&#10;&#9;&#9;&#9;&#125;&#10;&#9;&#9;&#125;&#10;&#9;&#9;catch(Exception e)&#10;&#9;&#9;&#123;&#10;&#9;&#9;&#9;e.printStackTrace();&#10;&#9;&#9;&#9;return;&#10;&#9;&#9;&#125;&#10;&#9;&#9;&#10;&#9;&#9;response.getWriter().print(&#34;UPLOAD DONE&#34;);&#10;&#9;&#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>重新编译，在编译的时候需要添加commons-fileupload的jar包，否则会报错。替换原来的class文件，然后把这两个jar包拷贝到Tomcat的lib目录下。再上传文件就是原来的文件了。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/08/24/game_networking_sending_and_receiving_packets/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          游戏网络——数据包的接收和发送
        
      </div>
    </a>
  
  
    <a href="/2015/08/20/game_networking_tcp_udp/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">游戏网络——TCP和UDP</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>






</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 YangHui
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>